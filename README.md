Mirtek_GW


Источник
https://radiokot.ru/forum/viewtopic.php?f=25&t=171991&sid=7b3c808c03e1419bcb42bf007edf50a4&start=40
Автор Vittaly76

К PIN16 можно подключить светодиод - будет показывать статус подключения к WiFi.

Устройство умеет отправлять 7 разных пакетов-запросов. В ответ приходит пакет-ответ.
Запррос показаний счётчика - 5.
В ответ, помимо самого пакета-ответа, придёт 3 параметра: сумма, Т1 и Т2.
Запрос текущих значений электросети (напряжения по фазам, токи по фазам и т.д.) - 7.
В ответ, помимо самого пакета-ответа, придут эти параметры.

Умеет работать по MQTT и через Serial.
При первом включении устройство создаёт AP "Mirtek_GW".
К ней можно подключиться по WiFi (пароль 12345678) и зайти браузером по 192.168.4.1.
Далее через WEB конфигурятся параметры вашего WiFi, сервера MQTT и номер счётчика.

В режиме Serial:
отправляем цифру-номер запроса от 1 до 7. В ответ приходит пакет-ответ от счетчика. Если это запросы 5 или 7, то помимо этого придут распарсенные значения параметров (см. выше).

В режиме MQTT:
в топик mirtek/action отправить номер запроса 5 или 7 (в MQTT реализовал только их). В ответ в отдельные топики придут соответствующие значения параметров счётчика, а также в отдельный топик mirtek/Request_Status результат запроса: Ok или Error.


Но есть проблема:
запрос текущих параметров сети (напряжения, токи и т.д.)
работает сильно криво: ответ приходит сильно битый, CRC не совпадает.
Правильное значение можно получить 1 раз из 100. Причём на всех соседских счётчиках аналогичная ситуация. Не знаю, с чем это связано, но очень обидно. Возможно, нужно направлять другой пакет-запрос. Я направляю тот, что был ранее указан в этой ветке форума. Примерно такого вида: 10 73 55 21 0 XX XX 9 FF 2B 0 0 0 0 0 5C 55 (XX - это номер счётчика). Если бы кто-нибудь смог помочь, и прислать запрос, который отправляет пульт для отображения текущий параметров сети, был бы очень благодарен.

Код написан в среде Arduino, использованные дополнительные библиотеки:
https://github.com/LSatan/SmartRC-CC1101-Driver-Lib
https://github.com/prampec/IotWebConf
https://github.com/RobTillaart/CRC
https://github.com/GyverLibs/TimerMs

Огромное спасибо Сергею Безрукову (Ser60), Dismas, _borisovich_, Vasfed! Без вашей информации я бы не справился.
 
